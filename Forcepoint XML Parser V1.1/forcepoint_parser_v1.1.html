<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Forcepoint XML Parser V1.1</title>
<link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@300;400;500;700&family=Outfit:wght@300;400;600;700;900&display=swap" rel="stylesheet"/>
<style>
:root{
  --bg:#04080f;--s1:#080d18;--s2:#0b1220;--card:#0e1829;
  --bdr:#132034;--bdr2:#1a2d47;
  --acc:#00d4ff;--acc2:#7c3aed;--grn:#00c98d;--red:#ff4757;--org:#ffa94d;--yel:#ffe066;
  --txt:#c8d8e8;--mut:#3d5a78;
  --mono:'JetBrains Mono',monospace;--sans:'Outfit',sans-serif;
}
*{box-sizing:border-box;margin:0;padding:0}
body{background:var(--bg);color:var(--txt);font-family:var(--sans);min-height:100vh;overflow-x:hidden}
body::before{content:'';position:fixed;inset:0;pointer-events:none;z-index:0;
  background-image:linear-gradient(rgba(0,212,255,.018) 1px,transparent 1px),linear-gradient(90deg,rgba(0,212,255,.018) 1px,transparent 1px);
  background-size:52px 52px}
body::after{content:'';position:fixed;top:-80px;left:50%;transform:translateX(-50%);
  width:1000px;height:260px;pointer-events:none;z-index:0;
  background:radial-gradient(ellipse,rgba(0,212,255,.055) 0%,transparent 68%)}
.wrap{position:relative;z-index:1;max-width:1900px;margin:0 auto;padding:0 28px}

/* HEADER */
header{padding:24px 0 18px;border-bottom:1px solid var(--bdr);display:flex;align-items:center;gap:16px}
.logo{width:46px;height:46px;flex-shrink:0;border-radius:12px;
  background:linear-gradient(135deg,var(--acc),var(--acc2));
  display:flex;align-items:center;justify-content:center;font-size:20px;
  box-shadow:0 0 22px rgba(0,212,255,.22)}
.brand-title{font-size:20px;font-weight:900;letter-spacing:-.3px}
.brand-title span{color:var(--acc)}
.brand-sub{font-size:10px;color:var(--mut);font-family:var(--mono);margin-top:2px;letter-spacing:.5px}
.hdr-right{margin-left:auto;display:flex;gap:20px;align-items:center}
.hstat{text-align:right}
.hstat-v{font-size:19px;font-weight:900;font-family:var(--mono);color:var(--acc);line-height:1}
.hstat-l{font-size:9px;color:var(--mut);text-transform:uppercase;letter-spacing:1px;margin-top:1px}

/* BUTTONS */
.btn{display:inline-flex;align-items:center;gap:7px;padding:8px 18px;border-radius:8px;border:none;
  font-family:var(--sans);font-size:12px;font-weight:700;cursor:pointer;transition:all .2s}
.btn:disabled{opacity:.35;cursor:not-allowed}
.btn-primary{background:linear-gradient(135deg,var(--acc),var(--acc2));color:#fff}
.btn-primary:not(:disabled):hover{opacity:.85;transform:translateY(-1px)}
.btn-outline{background:transparent;border:1px solid var(--bdr2);color:var(--txt)}
.btn-outline:not(:disabled):hover{border-color:var(--acc);color:var(--acc)}
.btn-green{background:rgba(0,201,141,.12);border:1px solid rgba(0,201,141,.25);color:var(--grn)}
.btn-green:not(:disabled):hover{background:rgba(0,201,141,.22)}
.btn-sm{padding:5px 12px;font-size:11px;border-radius:7px}

/* UPLOAD */
#view-upload{padding:70px 0;display:flex;flex-direction:column;align-items:center}
.drop-zone{width:100%;max-width:600px;border:2px dashed var(--bdr2);border-radius:18px;
  padding:64px 44px;text-align:center;cursor:pointer;background:var(--s1);
  position:relative;overflow:hidden;transition:all .3s}
.drop-zone::before{content:'';position:absolute;inset:0;
  background:radial-gradient(ellipse at 50% 0%,rgba(0,212,255,.07) 0%,transparent 65%);
  opacity:0;transition:opacity .3s}
.drop-zone:hover,.drop-zone.drag{border-color:var(--acc)}
.drop-zone:hover::before,.drop-zone.drag::before{opacity:1}
.drop-icon{font-size:54px;margin-bottom:14px;display:block;filter:drop-shadow(0 0 12px rgba(0,212,255,.3))}
.drop-h{font-size:22px;font-weight:900;margin-bottom:8px}
.drop-s{color:var(--mut);font-size:11px;font-family:var(--mono);margin-bottom:22px}
#file-input{display:none}

/* PROGRESS */
#view-progress{display:none;padding:70px 0;text-align:center}
.spin{font-size:50px;display:inline-block;animation:rot 1.4s linear infinite;margin-bottom:14px}
@keyframes rot{to{transform:rotate(360deg)}}
.prog-h{font-size:17px;font-weight:700;margin-bottom:18px}
.prog-track{height:3px;background:var(--bdr2);border-radius:99px;overflow:hidden;width:340px;margin:0 auto 10px}
.prog-bar{height:100%;background:linear-gradient(90deg,var(--acc),var(--acc2));width:0%;border-radius:99px;transition:width .35s}
.prog-lbl{font-family:var(--mono);font-size:10px;color:var(--mut)}

/* MAIN */
#view-main{display:none;padding:18px 0 60px}
.tabs{display:flex;gap:2px;flex-wrap:nowrap;overflow-x:auto;
  background:var(--s2);border:1px solid var(--bdr);border-radius:12px;padding:4px;margin-bottom:20px}
.tabs::-webkit-scrollbar{height:3px}
.tabs::-webkit-scrollbar-thumb{background:var(--bdr2);border-radius:99px}
.tab-btn{flex-shrink:0;padding:8px 16px;border-radius:8px;border:none;background:transparent;
  color:var(--mut);font-family:var(--sans);font-size:12px;font-weight:700;cursor:pointer;
  transition:all .2s;display:flex;align-items:center;gap:7px;white-space:nowrap}
.tab-btn .badge{background:var(--bdr2);color:var(--mut);font-family:var(--mono);
  font-size:9px;padding:1px 6px;border-radius:99px;transition:all .2s}
.tab-btn.active{background:rgba(0,212,255,.1);color:var(--acc);border:1px solid rgba(0,212,255,.2)}
.tab-btn.active .badge{background:rgba(0,212,255,.2);color:var(--acc)}

/* PANEL */
.panel{background:var(--s1);border:1px solid var(--bdr);border-radius:14px;overflow:hidden}
.panel-hdr{padding:13px 18px;border-bottom:1px solid var(--bdr);display:flex;align-items:center;gap:10px;flex-wrap:wrap}
.panel-title{font-size:15px;font-weight:800}
.panel-meta{font-family:var(--mono);font-size:10px;color:var(--mut)}
.spacer{flex:1}
.search-box{background:var(--card);border:1px solid var(--bdr2);border-radius:8px;
  padding:7px 12px;color:var(--txt);font-family:var(--mono);font-size:11px;
  outline:none;transition:border-color .2s;width:220px}
.search-box:focus{border-color:var(--acc)}
.search-box::placeholder{color:var(--mut)}

/* TABLE */
.tbl-wrap{overflow:auto;max-height:62vh}
.tbl-wrap::-webkit-scrollbar{width:5px;height:5px}
.tbl-wrap::-webkit-scrollbar-thumb{background:var(--bdr2);border-radius:99px}
table{width:100%;border-collapse:collapse;font-family:var(--mono);font-size:11px}
thead th{position:sticky;top:0;z-index:2;background:#060c18;color:var(--acc);
  padding:9px 14px;text-align:left;font-size:9px;font-weight:700;
  text-transform:uppercase;letter-spacing:.7px;white-space:nowrap;
  border-bottom:1px solid var(--bdr2);cursor:pointer;user-select:none}
thead th:hover{color:#fff}
.sort-ic{color:var(--mut);font-size:10px;margin-left:3px}
tbody tr{border-bottom:1px solid rgba(255,255,255,.022);transition:background .1s}
tbody tr:hover{background:rgba(0,212,255,.032)}
tbody td{padding:8px 14px;vertical-align:middle;max-width:300px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.no-data{text-align:center;padding:52px;color:var(--mut)}
.c-name{color:#ddeeff;font-weight:600}
.c-ip{color:var(--org)}
.c-port{color:var(--yel)}
.c-mut{color:var(--mut);font-size:10px}
.c-zone{color:#a78bfa}
.pill{display:inline-block;padding:2px 8px;border-radius:99px;font-size:9px;font-weight:700;margin:1px;white-space:nowrap;font-family:var(--mono)}
.p-tcp{background:rgba(0,212,255,.1);color:var(--acc);border:1px solid rgba(0,212,255,.2)}
.p-udp{background:rgba(124,58,237,.12);color:#a78bfa;border:1px solid rgba(124,58,237,.25)}
.p-mem{background:rgba(0,201,141,.08);color:var(--grn);border:1px solid rgba(0,201,141,.18)}
.p-zone{background:rgba(167,139,250,.1);color:#c4b5fd;border:1px solid rgba(167,139,250,.2)}
.p-svc{background:rgba(255,169,77,.1);color:var(--org);border:1px solid rgba(255,169,77,.2)}
.p-more{color:var(--mut);font-size:9px;vertical-align:middle;margin-left:3px}
.act-allow{color:var(--grn);font-weight:700}
.act-deny{color:var(--red);font-weight:700}
.st-on{color:var(--grn)}
.st-off{color:var(--mut)}
.log-yes{color:var(--acc)}
.log-no{color:var(--mut)}

/* PAGER */
.pager{padding:11px 18px;border-top:1px solid var(--bdr);display:flex;align-items:center;gap:7px}
.pager-info{font-family:var(--mono);font-size:10px;color:var(--mut);flex:1}
.pager-btn{background:var(--card);border:1px solid var(--bdr2);color:var(--txt);
  padding:4px 11px;border-radius:6px;cursor:pointer;font-family:var(--mono);font-size:11px;transition:all .15s}
.pager-btn:hover:not(:disabled){background:var(--acc);color:#000;border-color:var(--acc)}
.pager-btn:disabled{opacity:.35;cursor:not-allowed}
.pager-btn.cur{background:var(--acc);color:#000;border-color:var(--acc)}

/* TOAST */
.toast{position:fixed;bottom:22px;left:50%;transform:translateX(-50%) translateY(12px);
  background:var(--grn);color:#000;padding:9px 20px;border-radius:9px;
  font-weight:700;font-size:12px;opacity:0;transition:all .28s;z-index:999;pointer-events:none;white-space:nowrap}
.toast.on{opacity:1;transform:translateX(-50%) translateY(0)}

@media(max-width:640px){.hdr-right{display:none}.search-box{width:140px}}
</style>
</head>
<body>
<div class="wrap">

<header>
  <div class="logo">üõ°Ô∏è</div>
  <div>
    <div class="brand-title">Forcepoint XML Parser <span>V1.1</span></div>
    <div class="brand-sub">network objects &amp; policy extractor</div>
  </div>
  <div class="hdr-right" id="hdr-right"></div>
</header>

<div id="view-upload">
  <div class="drop-zone" id="drop-zone" onclick="document.getElementById('file-input').click()">
    <span class="drop-icon">üìÇ</span>
    <div class="drop-h">Drop Forcepoint XML here</div>
    <div class="drop-s">drag &amp; drop &nbsp;¬∑&nbsp; click to browse &nbsp;¬∑&nbsp; .xml only</div>
    <button class="btn btn-primary" onclick="event.stopPropagation();document.getElementById('file-input').click()">Browse File</button>
  </div>
  <input type="file" id="file-input" accept=".xml" onchange="onFilePick(this.files[0])"/>
</div>

<div id="view-progress">
  <div class="spin">‚öôÔ∏è</div>
  <div class="prog-h">Parsing file...</div>
  <div class="prog-track"><div class="prog-bar" id="prog-bar"></div></div>
  <div class="prog-lbl" id="prog-lbl">reading xml...</div>
</div>

<div id="view-main">
  <div class="tabs" id="tabs"></div>
  <div id="sheet-area"></div>
</div>

</div>
<div class="toast" id="toast"></div>

<script>
const PAGE = 150;
let data={}, curKey=null, curRows=[], curPage=1, sortCol=-1, sortDir=1;

// Drag & Drop
const dz = document.getElementById('drop-zone');
dz.addEventListener('dragover',  e=>{e.preventDefault();dz.classList.add('drag')});
dz.addEventListener('dragleave', ()=>dz.classList.remove('drag'));
dz.addEventListener('drop', e=>{e.preventDefault();dz.classList.remove('drag');onFilePick(e.dataTransfer.files[0])});

function onFilePick(file) {
  if (!file?.name.endsWith('.xml')) { toast('File must be .xml','#ef4444'); return; }
  document.getElementById('view-upload').style.display  ='none';
  document.getElementById('view-progress').style.display='block';
  animProg();
  const r = new FileReader();
  r.onload = ev => {
    try {
      const dom = new DOMParser().parseFromString(ev.target.result,'text/xml');
      if (dom.querySelector('parsererror')) throw new Error('Invalid XML');
      stopProg(); buildData(dom); renderAll();
    } catch(e) {
      toast(e.message,'#ef4444');
      document.getElementById('view-upload').style.display  ='block';
      document.getElementById('view-progress').style.display='none';
    }
  };
  r.readAsText(file);
}

let _pi;
function animProg() {
  const b=document.getElementById('prog-bar'), l=document.getElementById('prog-lbl');
  const msgs=['reading xml...','parsing nodes...','extracting hosts...','building services...','processing policies...','almost done...'];
  let w=0,si=0;
  _pi=setInterval(()=>{
    w=Math.min(w+Math.random()*11,88); b.style.width=w+'%';
    if(si<msgs.length) l.textContent=msgs[si++];
  },300);
}
function stopProg(){clearInterval(_pi);document.getElementById('prog-bar').style.width='100%'}

// Helpers
const $$=(ctx,sel)=>[...ctx.querySelectorAll(sel)];
const at=(el,a,d='')=>el?(el.getAttribute(a)||d):d;
const esc=s=>String(s??'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
function pills(arr,cls,max=5){
  if(!arr?.length) return '<span class="c-mut">‚Äî</span>';
  const s=arr.slice(0,max).map(v=>`<span class="pill ${cls}">${esc(v)}</span>`).join('');
  const m=arr.length>max?`<span class="p-more">+${arr.length-max}</span>`:'';
  return s+m;
}

// ‚îÄ‚îÄ BUILD DATA ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function buildData(dom) {
  data={};

  // 1. Hosts
  data.hosts={label:'Hosts',icon:'üñ•Ô∏è',
    cols:['Name','IP Address','Comment'],
    rows:$$(dom,'host').reduce((a,el)=>{
      const ip=at(el.querySelector('mvia_address'),'address');
      if(ip) a.push([at(el,'name'),ip,at(el,'comment')]);
      return a;
    },[])
  };

  // 2. Networks
  data.networks={label:'Networks',icon:'üåê',
    cols:['Name','Network IP','Subnet Mask','CIDR'],
    rows:$$(dom,'network').reduce((a,el)=>{
      const cidr=at(el,'ipv4_network'); if(!cidr) return a;
      const [addr,bits]=cidr.split('/');
      let mask='';
      if(bits!==undefined){const n=parseInt(bits),m=n===0?0:(~0<<(32-n))>>>0;mask=[(m>>>24)&255,(m>>>16)&255,(m>>>8)&255,m&255].join('.');}
      a.push([at(el,'name'),addr,mask,cidr]); return a;
    },[])
  };

  // 3. Address Ranges
  data.addr_ranges={label:'Address Ranges',icon:'üìè',
    cols:['Name','Start IP','End IP','Full Range'],
    rows:$$(dom,'address_range').reduce((a,el)=>{
      const r=at(el,'ip_range'); if(!r) return a;
      const [s,e]=r.split('-');
      a.push([at(el,'name'),s||'',e||'',r]); return a;
    },[])
  };

  // 4. Address Groups
  data.addr_groups={label:'Address Groups',icon:'üìÅ',
    cols:['Name','Members','Member Count'],
    rows:$$(dom,'group').map(el=>{
      const m=$$(el,'ne_list').map(n=>at(n,'ref')).filter(Boolean);
      return[at(el,'name'),m,m.length];
    })
  };

  // 5. Services
  {const rows=[];
  $$(dom,'service_tcp').forEach(el=>{
    const mn=at(el,'min_dst_port'),mx=at(el,'max_dst_port',mn);
    rows.push([at(el,'name'),mn===mx?mn:`${mn}‚Äì${mx}`,'TCP',at(el,'comment')]);
  });
  $$(dom,'service_udp').forEach(el=>{
    const mn=at(el,'min_dst_port'),mx=at(el,'max_dst_port',mn);
    rows.push([at(el,'name'),mn===mx?mn:`${mn}‚Äì${mx}`,'UDP',at(el,'comment')]);
  });
  data.services={label:'Services',icon:'üîå',cols:['Name','Port / Range','Protocol','Comment'],rows};}

  // 6. Service Groups
  data.svc_groups={label:'Service Groups',icon:'üì¶',
    cols:['Name','Members','Member Count'],
    rows:$$(dom,'gen_service_group').map(el=>{
      const m=$$(el,'service_ref').map(s=>at(s,'ref')).filter(Boolean);
      return[at(el,'name'),m,m.length];
    })
  };

  // 7. Zones
  data.zones={label:'Zones',icon:'üó∫Ô∏è',
    cols:['Zone Name','DB Key'],
    rows:$$(dom,'interface_zone').map(el=>[at(el,'name'),at(el,'db_key')])
  };

  // 8. Policies
  {const rows=[];let idx=1;
  $$(dom,'rule_entry').forEach(el=>{
    const mp=el.querySelector('match_part'); if(!mp) return;
    const srcs=$$(mp,'match_sources match_source_ref').map(r=>at(r,'value')).filter(v=>v&&v!=='none');
    const dsts=$$(mp,'match_destinations match_destination_ref').map(r=>at(r,'value')).filter(v=>v&&v!=='none');
    const svcs=$$(mp,'match_services match_service_ref').map(r=>at(r,'value')).filter(v=>v&&v!=='none'&&v!=='ANY');
    const action=at(el.querySelector('action'),'type','allow');
    const lp=el.querySelector('option log_policy');
    const lvl=at(lp,'log_level','undefined');
    const logged=lvl==='stored'||lvl==='essential';
    const disabled=el.getAttribute('is_disabled')==='true';
    const comment=at(el,'comment');
    const tag=at(el,'tag');
    const name=comment?comment.slice(0,60):(tag||`Rule #${idx}`);
    // Note: Forcepoint stores zones at interface level, not rule level
    rows.push([idx++,name,'‚Äî','‚Äî',srcs,dsts,svcs,logged,!disabled,action]);
  });
  data.policies={label:'Policies',icon:'üìã',
    cols:['#','Name / Comment','Src Zone','Dst Zone','Source Network','Dest Network','Service / Port','Log','Status','Action'],
    rows};}
}

// ‚îÄ‚îÄ RENDER ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderAll(){
  const s=[
    {v:data.hosts.rows.length,l:'Hosts'},
    {v:data.networks.rows.length,l:'Networks'},
    {v:data.services.rows.length,l:'Services'},
    {v:data.policies.rows.length,l:'Policies'},
    {v:data.zones.rows.length,l:'Zones'},
  ];
  document.getElementById('hdr-right').innerHTML=
    s.map(x=>`<div class="hstat"><div class="hstat-v">${x.v.toLocaleString()}</div><div class="hstat-l">${x.l}</div></div>`).join('')+
    `<button class="btn btn-outline btn-sm" onclick="resetApp()" style="margin-left:8px">‚Ü∫ New File</button>`;
  document.getElementById('tabs').innerHTML=Object.entries(data).map(([k,sh])=>
    `<button class="tab-btn" id="tb-${k}" onclick="openSheet('${k}')">${sh.icon} ${sh.label}<span class="badge">${sh.rows.length}</span></button>`
  ).join('');
  document.getElementById('view-progress').style.display='none';
  document.getElementById('view-main').style.display='block';
  openSheet('hosts');
}

function openSheet(key){
  curKey=key;curPage=1;sortCol=-1;sortDir=1;
  document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
  document.getElementById('tb-'+key)?.classList.add('active');
  const sh=data[key]; curRows=[...sh.rows];
  document.getElementById('sheet-area').innerHTML=`
    <div class="panel">
      <div class="panel-hdr">
        <div><div class="panel-title">${sh.icon} ${sh.label}</div>
        <div class="panel-meta">${sh.rows.length.toLocaleString()} records ¬∑ ${sh.cols.length} columns</div></div>
        <div class="spacer"></div>
        <input class="search-box" id="srch" placeholder="Search‚Ä¶" oninput="doSearch(this.value)"/>
        <button class="btn btn-green btn-sm" onclick="exportCSV()">‚Üì Export CSV</button>
      </div>
      <div class="tbl-wrap" id="tbl-wrap">
        <table>
          <thead id="t-head"></thead>
          <tbody id="t-body"></tbody>
        </table>
      </div>
      <div class="pager">
        <div class="pager-info" id="pg-info"></div>
        <button class="pager-btn" id="pg-prev" onclick="goPage(curPage-1)">¬´</button>
        <div id="pg-nums" style="display:flex;gap:4px"></div>
        <button class="pager-btn" id="pg-next" onclick="goPage(curPage+1)">¬ª</button>
      </div>
    </div>`;
  document.getElementById('t-head').innerHTML='<tr>'+
    sh.cols.map((c,i)=>`<th onclick="doSort(${i})">${esc(c)}<span class="sort-ic" id="si-${i}">‚¨ç</span></th>`).join('')+'</tr>';
  renderTable();
}

function renderTable(){
  const sh=data[curKey],total=curRows.length,start=(curPage-1)*PAGE,end=Math.min(start+PAGE,total),slice=curRows.slice(start,end);
  document.getElementById('t-body').innerHTML=slice.length
    ?slice.map(r=>`<tr>${renderRow(curKey,r)}</tr>`).join('')
    :`<tr><td colspan="${sh.cols.length}" class="no-data">No records found</td></tr>`;
  const tp=Math.max(1,Math.ceil(total/PAGE));
  document.getElementById('pg-info').textContent=total?`${(start+1).toLocaleString()} ‚Äì ${end.toLocaleString()} of ${total.toLocaleString()} records`:'No records';
  document.getElementById('pg-prev').disabled=curPage<=1;
  document.getElementById('pg-next').disabled=curPage>=tp;
  let nums='';
  for(let p=Math.max(1,curPage-2);p<=Math.min(tp,curPage+2);p++)
    nums+=`<button class="pager-btn${p===curPage?' cur':''}" onclick="goPage(${p})">${p}</button>`;
  document.getElementById('pg-nums').innerHTML=nums;
}

function renderRow(key,r){
  switch(key){
    case 'hosts':
      return `<td class="c-name">${esc(r[0])}</td><td class="c-ip">${esc(r[1])}</td><td class="c-mut">${esc(r[2])}</td>`;
    case 'networks':
      return `<td class="c-name">${esc(r[0])}</td><td class="c-ip">${esc(r[1])}</td><td class="c-ip">${esc(r[2])}</td><td class="c-mut">${esc(r[3])}</td>`;
    case 'addr_ranges':
      return `<td class="c-name">${esc(r[0])}</td><td class="c-ip">${esc(r[1])}</td><td class="c-ip">${esc(r[2])}</td><td class="c-mut">${esc(r[3])}</td>`;
    case 'addr_groups':
      return `<td class="c-name">${esc(r[0])}</td><td>${pills(r[1],'p-mem')}</td><td class="c-mut">${r[2]}</td>`;
    case 'services':
      return `<td class="c-name">${esc(r[0])}</td><td class="c-port">${esc(r[1])}</td><td><span class="pill ${r[2]==='TCP'?'p-tcp':'p-udp'}">${r[2]}</span></td><td class="c-mut">${esc(r[3])}</td>`;
    case 'svc_groups':
      return `<td class="c-name">${esc(r[0])}</td><td>${pills(r[1],'p-svc')}</td><td class="c-mut">${r[2]}</td>`;
    case 'zones':
      return `<td class="c-zone" style="font-size:13px;font-weight:700">${esc(r[0])}</td><td class="c-mut">${esc(r[1])}</td>`;
    case 'policies':{
      const act=r[9]==='allow'?'<span class="act-allow">‚úì Allow</span>':'<span class="act-deny">‚úï Deny</span>';
      const st=r[8]?'<span class="st-on">‚óè Enabled</span>':'<span class="st-off">‚óã Disabled</span>';
      const lg=r[7]?'<span class="log-yes">‚úì Yes</span>':'<span class="log-no">‚Äî No</span>';
      return `
        <td class="c-mut" style="width:42px">${r[0]}</td>
        <td class="c-name" style="max-width:220px" title="${esc(r[1])}">${esc(r[1]).slice(0,55)}${r[1].length>55?'‚Ä¶':''}</td>
        <td>${r[2]==='‚Äî'?'<span class="c-mut">‚Äî</span>':pills([r[2]],'p-zone')}</td>
        <td>${r[3]==='‚Äî'?'<span class="c-mut">‚Äî</span>':pills([r[3]],'p-zone')}</td>
        <td>${pills(r[4],'p-mem',4)}</td>
        <td>${pills(r[5],'p-mem',4)}</td>
        <td>${r[6].length?pills(r[6],'p-svc',4):'<span class="c-mut">Any</span>'}</td>
        <td>${lg}</td><td>${st}</td><td>${act}</td>`;
    }
    default: return r.map(v=>`<td>${esc(Array.isArray(v)?v.join(', '):v)}</td>`).join('');
  }
}

function doSearch(q){
  q=q.toLowerCase().trim();
  const sh=data[curKey];
  curRows=q?sh.rows.filter(r=>r.some(c=>Array.isArray(c)?c.some(v=>String(v).toLowerCase().includes(q)):String(c??'').toLowerCase().includes(q))):[...sh.rows];
  curPage=1;renderTable();
}

function doSort(ci){
  if(sortCol===ci)sortDir*=-1;else{sortCol=ci;sortDir=1;}
  document.querySelectorAll('.sort-ic').forEach((el,i)=>el.textContent=i===ci?(sortDir===1?'‚Üë':'‚Üì'):'‚¨ç');
  curRows.sort((a,b)=>{
    let va=a[ci],vb=b[ci];
    if(Array.isArray(va))va=va.join(',');
    if(Array.isArray(vb))vb=vb.join(',');
    const na=parseFloat(va),nb=parseFloat(vb);
    if(!isNaN(na)&&!isNaN(nb))return(na-nb)*sortDir;
    return String(va??'').localeCompare(String(vb??''))*sortDir;
  });
  curPage=1;renderTable();
}

function goPage(p){
  curPage=Math.max(1,Math.min(p,Math.ceil(curRows.length/PAGE)||1));
  renderTable();document.getElementById('tbl-wrap')?.scrollTo(0,0);
}

function exportCSV(){
  const sh=data[curKey];
  const rows=document.getElementById('srch')?.value.trim()?curRows:sh.rows;
  let csv=sh.cols.map(c=>'"'+c.replace(/"/g,'""')+'"').join(',')+'\r\n';
  rows.forEach(r=>{csv+=r.map(cell=>{const v=Array.isArray(cell)?cell.join(' | '):String(cell??'');return'"'+v.replace(/"/g,'""')+'"';}).join(',')+'\r\n';});
  const a=document.createElement('a');
  a.href=URL.createObjectURL(new Blob(['\uFEFF'+csv],{type:'text/csv;charset=utf-8;'}));
  a.download=`forcepoint_${curKey}_${new Date().toISOString().slice(0,10)}.csv`;
  a.click();toast(`Exported ${rows.length} rows ‚Äî ${sh.label}`);
}

function resetApp(){
  data={};curKey=null;curRows=[];
  document.getElementById('view-main').style.display  ='none';
  document.getElementById('view-upload').style.display='block';
  document.getElementById('file-input').value='';
  document.getElementById('hdr-right').innerHTML='';
}

function toast(msg,color){
  const t=document.getElementById('toast');
  t.textContent=msg;t.style.background=color||'var(--grn)';t.style.color=color?'#fff':'#000';
  t.classList.add('on');setTimeout(()=>t.classList.remove('on'),3000);
}
</script>
</body>
</html>
